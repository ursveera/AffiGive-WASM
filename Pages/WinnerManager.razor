@page "/admin/winners"
@using AffiGive_API_V1.Models
@using AffiGive_API_V1.DTO
@using AffigiveUIBalzor.api
@using SharedLib.DTO
@inject IWinnerApiGateway WinnerApi
@inject IEntryApiGateway EntryApi

<h3 class="mb-3">🏆 Winner Manager (Full CRUD)</h3>

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert alert-info">@message</div>
}

<!-- ===========================================================
     CRUD FORM
=============================================================== -->
<div class="card p-3 shadow-sm mb-4">
    <h5 class="fw-bold mb-3">@((editMode) ? "✏️ Edit Winner" : "➕ Add Winner")</h5>

    <div class="row g-3">

        <!-- Entry Select -->
        <div class="col-md-4">
            <label>Entry</label>
            <select class="form-control" @bind="winnerModel.EntryId">
                <option value="">-- Select Entry --</option>
               @*  @foreach (var e in allEntries)
                {
                    <option value="@e.Id">@e.NickName (@e.Email)</option>
                } *@
            </select>
        </div>

        <div class="col-md-4">
            <label>Code</label>
            <input class="form-control" @bind="winnerModel.Code" />
        </div>

        <div class="col-md-4">
            <label>Draw Date</label>

            <input type="date"
                   class="form-control"
                   value="@(winnerModel.DrawDate == DateTime.MinValue
                                           ? ""
                                           : winnerModel.DrawDate.ToString("yyyy-MM-dd"))"
                   @onchange="e => winnerModel.DrawDate =
                   string.IsNullOrWhiteSpace(e.Value?.ToString())
                       ? DateTime.MinValue
                       : DateTime.Parse(e.Value!.ToString())" />
        </div>

        <div class="col-md-4">
            <label>Status</label>
            <input class="form-control" @bind="winnerModel.Status" />
        </div>

        <div class="col-md-12 mt-3">
            @if (editMode)
            {
                <button class="btn btn-warning me-2" @onclick="UpdateWinner">Update</button>
                <button class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
            }
            else
            {
                <button class="btn btn-primary" @onclick="AddWinner">Add Winner</button>
            }
        </div>
    </div>
</div>

<!-- ===========================================================
     PICK WINNER
=============================================================== -->
<div class="card p-3 shadow-sm mb-4">
    <h5 class="fw-bold mb-3">🎉 Pick Winner</h5>

    <div class="input-group">
        <input class="form-control" placeholder="Enter video code..." @bind="pickCode" />
        <button class="btn btn-success" @onclick="PickWinner">Pick</button>
    </div>
</div>

<!-- ===========================================================
     SEARCH & LOAD ACTIONS
=============================================================== -->
<div class="d-flex gap-2 mb-3">

    <input class="form-control" style="max-width:250px"
           placeholder="Search code..."
           @bind="searchCode"
           @oninput="FilterList" />

    <button class="btn btn-secondary" @onclick="LoadWinnersByCode">
        🔍 Search Code
    </button>

    <button class="btn btn-dark" @onclick="LoadAllWinners">
        📋 Load All Winners
    </button>

    <button class="btn btn-info text-white" @onclick="LoadWinnerEntries">
        🧾 Winner + Entry
    </button>

    <button class="btn btn-primary" @onclick="LoadAllWinnerEntries">
        📚 All Winner Entries
    </button>
</div>

<!-- ===========================================================
     WINNERS TABLE
=============================================================== -->
@if (filteredWinners.Any())
{
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header fw-bold bg-white">
            🏅 Winners List ( @filteredWinners.Count )
        </div>

        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Entry ID</th>
                    <th>Code</th>
                    <th>Draw Date</th>
                    <th>Status</th>
                    <th>Delete Status</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var w in filteredWinners)
                {
                    <tr>
                        <td>@w.EntryId</td>
                        <td>@w.Code</td>
                        <td>@w.DrawDate.ToString("yyyy-MM-dd")</td>
                        <td>@w.Status</td>
                        <td>@(w.SoftDelete == 1 ? "Deleted" : "Live")</td>

                        <td class="text-end">
                            <button class="btn btn-primary btn-sm me-1"
                                    @onclick="() => EditWinner(w.Id)">
                                Edit
                            </button>

                            <button class="btn btn-danger btn-sm me-1"
                                    @onclick="() => DeleteWinner(w.Id)">
                                Soft Delete
                            </button>

                            <button class="btn btn-dark btn-sm"
                                    @onclick="() => ForceDeleteWinner(w.Id)">
                                Force Delete
                            </button>
                        </td>

                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<!-- ===========================================================
     WINNER + ENTRY TABLE
=============================================================== -->
@if (winnerEntryList.Any())
{
    <div class="card shadow-sm mb-4">
        <div class="card-header fw-bold bg-white">
            🧾 Winner + Entry Details ( @winnerEntryList.Count )
        </div>

        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Code</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Draw Date</th>
                    <th>Delete Status</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var w in winnerEntryList)
                {
                    <tr>
                        <td>@w.Code</td>
                        <td>@w.Name</td>
                        <td>@w.Email</td>
                        <td>@w.Phone</td>
                        <td>@w.DrawDate.ToString("yyyy-MM-dd")</td>
                        <td>@w.SoftDelete</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {

    private string message = "";
    private string pickCode = "";
    private string searchCode = "";

    private bool editMode = false;

    private Winner winnerModel = new();
    private List<Winner> allWinners = new();
    private List<Winner> filteredWinners = new();

    private List<EntryDto> allEntries = new();       // ⭐ LOAD ENTRIES HERE
    private List<WinnerEntryDto> winnerEntryList = new();

    /* ===========================================================
        LOAD DATA
    ============================================================= */

    protected override async Task OnInitializedAsync()
    {
        var result = await EntryApi.GetAllAsync(1, 5000);  // ⭐ GET ALL ENTRIES
        allEntries = result.Items.ToList();

        await LoadAllWinners();
    }

    private async Task LoadAllWinners()
    {
        allWinners = await WinnerApi.GetAllAsync();
        filteredWinners = allWinners.ToList();
    }

    private async Task LoadWinnersByCode()
    {
        if (string.IsNullOrWhiteSpace(searchCode))
            return;

        filteredWinners = await WinnerApi.GetWinnersByCodeAsync(searchCode);
    }

    private void FilterList()
    {
        filteredWinners = allWinners
            .Where(x => x.Code.Contains(searchCode, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }

    /* ===========================================================
        CREATE WINNER
    ============================================================= */

    private async Task AddWinner()
    {
        if (winnerModel.DrawDate == DateTime.MinValue)
        {
            message = "Draw date is required!";
            return;
        }

        var ok = await WinnerApi.AddWinnerAsync(winnerModel);
        message = ok ? "Winner added!" : "Add failed";

        if (ok)
        {
            await LoadAllWinners();
            winnerModel = new();
        }
    }

    /* ===========================================================
        PICK WINNER
    ============================================================= */

    private async Task PickWinner()
    {
        if (string.IsNullOrWhiteSpace(pickCode))
            return;

        var result = await WinnerApi.PickWinnerAsync(pickCode);

        if (result != null)
            await LoadAllWinners();
        else
            message = "No valid entries!";
    }

    /* ===========================================================
        EDIT WINNER
    ============================================================= */

    private async Task EditWinner(Guid id)
    {
        var w = await WinnerApi.GetWinnerByIdAsync(id);
        if (w == null) return;

        winnerModel = w;
        editMode = true;
    }

    private async Task UpdateWinner()
    {
        var ok = await WinnerApi.UpdateWinnerAsync(winnerModel);
        message = ok ? "Updated!" : "Update failed";

        if (ok)
        {
            editMode = false;
            winnerModel = new();
            await LoadAllWinners();
        }
    }

    private void CancelEdit()
    {
        editMode = false;
        winnerModel = new();
    }

    /* ===========================================================
        DELETE WINNER
    ============================================================= */

    private async Task DeleteWinner(Guid id)
    {
        var ok = await WinnerApi.DeleteWinnerByIdAsync(id);

        if (ok)
            allWinners.RemoveAll(x => x.Id == id);

        filteredWinners = allWinners.ToList();
    }

    /* ===========================================================
        WINNER + ENTRY (JOIN)
    ============================================================= */

    private async Task LoadWinnerEntries()
    {
        if (string.IsNullOrWhiteSpace(searchCode))
            return;

        winnerEntryList = await WinnerApi.GetWinnerEntriesByCodeAsync(searchCode);
    }

    private async Task LoadAllWinnerEntries()
    {
        winnerEntryList = await WinnerApi.GetAllWinnerEntriesAsync();
    }
    private async Task ForceDeleteWinner(Guid id)
    {
        message = "Deleting permanently...";

        var ok = await WinnerApi.ForceDeleteWinnerAsync(id);

        if (ok)
        {
            allWinners.RemoveAll(x => x.Id == id);
            filteredWinners = allWinners.ToList();
            message = "Winner permanently deleted!";
        }
        else
        {
            message = "Force delete failed!";
        }
    }
}
