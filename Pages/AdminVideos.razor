@page "/admin/videos"
@using AffiGive_API_V1.Models
@using AffiGive_API_V1.DTO
@using AffigiveUIBalzor.api
@inject IAdminVideoApi VideoApi

<h3 class="mb-3">🎥 Video Manager</h3>

<!-- Search Filter -->
<input class="form-control mb-3"
       placeholder="Search videos..."
       @bind="searchText"
       @bind:event="oninput" />
<div class="card shadow-sm border-0 mb-4">

    <div class="card-header bg-white fw-semibold py-3 border-bottom">
        @(isEdit ? "✏️ Edit Video" : "➕ Add New Video")
    </div>

    <div class="card-body">

        <div class="row g-3">

            <div class="col-md-4">
                <label class="form-label fw-semibold">Video Code</label>
                <input class="form-control modern-input" @bind="videoModel.Code" />
            </div>

            <div class="col-md-4">
                <label class="form-label fw-semibold">Title</label>
                <input class="form-control modern-input" @bind="videoModel.Title" />
            </div>

            <div class="col-md-4">
                <label class="form-label fw-semibold">Thumbnail URL</label>
                <input class="form-control modern-input" @bind="videoModel.ThumbnailUrl" />
            </div>

            <div class="col-md-6">
                <label class="form-label fw-semibold">Video URL</label>
                <input class="form-control modern-input" @bind="videoModel.VideoUrl" />
            </div>

            <div class="col-md-6">
                <label class="form-label fw-semibold">Expires At</label>
                <input type="date"
                       class="form-control modern-input"
                       value="@(videoModel.ExpiresAt == DateTime.MinValue
                                                      ? ""
                                                      : videoModel.ExpiresAt.ToString("yyyy-MM-dd"))"
                       @onchange="e => videoModel.ExpiresAt = DateTime.Parse(e.Value!.ToString())" />
            </div>

            <div class="col-12 mt-3">
                @if (isEdit)
                {
                    <button class="btn btn-warning px-4 me-2 modern-btn" @onclick="UpdateVideo">
                        <i class="bi bi-save me-1"></i> Update
                    </button>

                    <button class="btn btn-secondary px-4 modern-btn" @onclick="CancelEdit">
                        <i class="bi bi-x-lg me-1"></i> Cancel
                    </button>
                }
                else
                {
                    <button class="btn btn-primary px-4 modern-btn" @onclick="AddVideo">
                        <i class="bi bi-plus-circle me-1"></i> Add Video
                    </button>
                }
            </div>
        </div>

    </div>
</div>
<div class="card shadow-sm border-0">
    <div class="card-header bg-white fw-semibold py-3 border-bottom">
        🎥 Video List
    </div>

    <div class="table-responsive" style="max-height: 480px; overflow-y: auto;">
        <table class="table table-hover align-middle mb-0">

            <thead class="table-light position-sticky top-0 shadow-sm" style="z-index: 5;">
                <tr>
                    <th class="sortable" @onclick="() => SortBy(nameof(Video.Code))">Code</th>
                    <th>Title</th>
                    <th>Thumbnail</th>
                    <th>Lucky Gift</th>
                    <th>Video URL</th>
                    <th class="sortable" @onclick="() => SortBy(nameof(Video.CreatedAt))">Created</th>
                    <th class="sortable" @onclick="() => SortBy(nameof(Video.ExpiresAt))">Expires</th>
                    <th class="text-end" style="width: 150px;">Actions</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var v in filteredVideos)
                {
                    <tr class="table-row-modern">
                        <td>@v.Code</td>
                        <td>@v.Title</td>

                        <td>
                            <img src="@v.ThumbnailUrl"
                                 class="rounded shadow-sm"
                                 style="width: 80px; height: 55px; object-fit: cover;" />
                        </td>
                        <td>
                            @if (v.Id == activeLuckyVideoId)
                            {
                                <span class="badge bg-success">Active</span>
                            }
                            else
                            {
                                <button class="btn btn-outline-warning btn-sm modern-btn"
                                        title="Set as Lucky Gift"
                                        @onclick="() => SetLuckyGift(v.Id)">
                                    🎁 Set
                                </button>
                            }
                        </td>


                        <td style="max-width:220px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
                            title="@v.VideoUrl">
                            <a href="@v.VideoUrl" target="_blank">@v.VideoUrl</a>
                        </td>

                        <td>@v.CreatedAt.ToString("dd-MM-yyyy HH:mm")</td>
                        <td>@v.ExpiresAt.ToString("dd-MM-yyyy")</td>

                        <td class="text-end">
                            <button class="btn btn-outline-primary btn-sm modern-btn me-1"
                                    title="Edit Video"
                                    @onclick="() => EditVideo(v)">
                                <i class="bi bi-pencil-square">Edit</i>
                            </button>

                            <button class="btn btn-outline-danger btn-sm modern-btn"
                                    title="Delete Video"
                                    @onclick="() => DeleteVideo(v.Code)">
                                <i class="bi bi-trash">Delete</i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>

        </table>
    </div>
</div>
<style>
    /* Modern Inputs */
    .modern-input {
        border-radius: 8px;
        padding: 10px;
        border: 1px solid #ced4da;
        transition: 0.25s;
    }

        .modern-input:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.15rem rgba(13,110,253,0.25);
        }

    /* Table Hover Animation */
    .table-row-modern:hover {
        background-color: #f1f5ff !important;
        transition: 0.2s ease-in-out;
    }

    /* Sortable Columns */
    th.sortable {
        cursor: pointer;
        user-select: none;
    }

        th.sortable:hover {
            color: #0d6efd;
        }

    /* Modern Buttons */
    .modern-btn {
        border-radius: 8px;
        transition: 0.2s;
    }

        .modern-btn:hover {
            transform: scale(1.08);
        }
</style>



@code {

    private List<Video> allVideos = new();
    private List<Video> filteredVideos = new();

    private Video videoModel = new();
    private bool isEdit = false;
    private string searchText = "";
    private string sortColumn = "";
    private bool sortAscending = true;
    private Guid? activeLuckyVideoId;

    // Load once like TaskManager (FAST)
    protected override async Task OnInitializedAsync()
    {
        var result = await VideoApi.GetAll(1, 10000); // Load everything once
        allVideos = result.Items.ToList();

        var lucky = await VideoApi.GetActiveLuckyGiftVideo();
        activeLuckyVideoId = lucky?.Id;

        ApplyFilter();
    }

    private void ApplyFilter()
    {
        filteredVideos = allVideos
            .Where(v => string.IsNullOrWhiteSpace(searchText)
                || v.Code.Contains(searchText, StringComparison.OrdinalIgnoreCase)
                || v.Title.Contains(searchText, StringComparison.OrdinalIgnoreCase)
                || v.VideoUrl.Contains(searchText, StringComparison.OrdinalIgnoreCase))
            .ToList();

        ApplySorting();
    }

    private void SortBy(string column)
    {
        if (sortColumn == column)
            sortAscending = !sortAscending;
        else
        {
            sortColumn = column;
            sortAscending = true;
        }

        ApplySorting();
    }

    private void ApplySorting()
    {
        if (!string.IsNullOrEmpty(sortColumn))
        {
            filteredVideos = sortAscending
                ? filteredVideos.OrderBy(v => v.GetType().GetProperty(sortColumn)?.GetValue(v)).ToList()
                : filteredVideos.OrderByDescending(v => v.GetType().GetProperty(sortColumn)?.GetValue(v)).ToList();
        }
    }

    // ---------- CRUD (FAST LIKE TASK MANAGER) ----------

    private async Task AddVideo()
    {
        videoModel.CreatedAt = DateTime.UtcNow;

        var ok = await VideoApi.Add(videoModel);
        if (!ok) return;

        allVideos.Add(videoModel);  // No reload
        ApplyFilter();

        videoModel = new();
    }

    private void EditVideo(Video v)
    {
        isEdit = true;
        videoModel = new Video
        {
            Id = v.Id,
            Code = v.Code,
            Title = v.Title,
            ThumbnailUrl = v.ThumbnailUrl,
            VideoUrl = v.VideoUrl,
            CreatedAt = v.CreatedAt,
            ExpiresAt = v.ExpiresAt
        };
    }

    private async Task UpdateVideo()
    {
        var ok = await VideoApi.Update(videoModel);
        if (!ok) return;

        var existing = allVideos.FirstOrDefault(v => v.Id == videoModel.Id);
        if (existing != null)
        {
            existing.Code = videoModel.Code;
            existing.Title = videoModel.Title;
            existing.ThumbnailUrl = videoModel.ThumbnailUrl;
            existing.VideoUrl = videoModel.VideoUrl;
            existing.ExpiresAt = videoModel.ExpiresAt;
        }

        ApplyFilter();

        isEdit = false;
        videoModel = new();
    }

    private async Task DeleteVideo(string code)
    {
        var video = allVideos.FirstOrDefault(v => v.Code == code);
        if (video?.Id == activeLuckyVideoId)
            return; // or show toast

        await VideoApi.DeleteByCode(code);

        allVideos.Remove(video!);
        ApplyFilter();
    }

    private void CancelEdit()
    {
        isEdit = false;
        videoModel = new();
    }
    private async Task SetLuckyGift(Guid id)
    {
        var ok = await VideoApi.PickLuckyGiftVideo(id);
        if (!ok) return;

        activeLuckyVideoId = id;
        StateHasChanged();
    }
}
