@page "/admin/appsettings"
@inject IAppSettingsApi Api
@using AffigiveUIBalzor.api
@using Newtonsoft.Json.Linq

<h3>AppSettings Viewer & Editor</h3>

@if (LocalSettings == null || ApiSettings == null)
{
    <p>Loading...</p>
}
else
{
    <!-- LOCAL APPSETTINGS (READ ONLY - TOP) -->
    <div class="mb-5">
        <h5>Local AppSettings (Read-only)</h5>

        <table class="table table-bordered table-sm">
            <thead>
                <tr>
                    <th style="width:40%">Key</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in LocalSettings)
                {
                    <tr>
                        <td>@item.Key</td>
                        <td>
                            <input class="form-control"
                                   value="@item.Value"
                                   disabled />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <hr />

    <!-- API APPSETTINGS (EDITABLE - BOTTOM) -->
    <div>
        <h5>API AppSettings (Editable)</h5>

        <EditForm Model="ApiSettings"
                  OnValidSubmit="Save"
                  FormName="ApiSettingsForm">

            <table class="table table-bordered table-sm">
                <thead>
                    <tr>
                        <th style="width:40%">Key</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in ApiSettings)
                    {
                        <tr>
                            <td>@item.Key</td>
                            <td>
                                <input class="form-control"
                                       @bind="ApiSettings[item.Key]" />
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <button class="btn btn-primary">Save API Settings</button>
        </EditForm>
    </div>
}

@if (!string.IsNullOrEmpty(Message))
{
    <div class="alert alert-success mt-3">@Message</div>
}

@code {

    Dictionary<string, string> LocalSettings;
    Dictionary<string, string> ApiSettings;
    string Message;

    protected override async Task OnInitializedAsync()
    {
        var json = await Api.GetSettingsAsync();
        var root = JObject.Parse(json);

        LocalSettings = Flatten((JObject)root["LocalAppSettings"]);
        ApiSettings = Flatten((JObject)root["ApiAppSettings"]);
    }

    async Task Save()
    {
        var obj = new JObject();

        foreach (var kv in ApiSettings)
        {
            Set(obj, kv.Key, kv.Value);
        }

        await Api.SaveSettingsAsync(
            obj.ToString(Newtonsoft.Json.Formatting.Indented)
        );

        Message = "API Settings saved successfully ✔";
    }

    Dictionary<string, string> Flatten(JObject obj, string parent = "")
    {
        var dict = new Dictionary<string, string>();

        foreach (var prop in obj.Properties())
        {
            var key = string.IsNullOrEmpty(parent)
                ? prop.Name
                : $"{parent}:{prop.Name}";

            if (prop.Value is JObject nested)
            {
                foreach (var kv in Flatten(nested, key))
                    dict[kv.Key] = kv.Value;
            }
            else
            {
                dict[key] = prop.Value?.ToString();
            }
        }

        return dict;
    }

    void Set(JObject obj, string key, string value)
    {
        var parts = key.Split(':');
        JToken current = obj;

        foreach (var part in parts[..^1])
        {
            current[part] ??= new JObject();
            current = current[part];
        }

        ((JObject)current)[parts[^1]] = value;
    }
}
