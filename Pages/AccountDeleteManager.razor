@page "/admin/account-deletions"
@using AffiGive_API_V1.Models
@using WASM.api
@inject IAccountDeleteRequestApi Api

<h3 class="mb-3">🧨 Account Deletion Requests</h3>

<!-- FILTER BAR -->
<div class="card shadow-sm border-0 mb-3">
    <div class="card-body d-flex flex-wrap gap-3 align-items-center">

        <input class="form-control w-25"
               placeholder="🔍 Search email / Google ID"
               @bind-value="searchText"
               @bind-value:event="oninput" />

        <div class="btn-group">
            <button class="btn btn-outline-secondary @(statusFilter == "All" ? "active" : "")"
                    @onclick='() => SetStatus("All")'>
                All
            </button>

            <button class="btn btn-outline-warning @(statusFilter == "Pending" ? "active" : "")"
                    @onclick='() => SetStatus("Pending")'>
                Pending
            </button>

            <button class="btn btn-outline-success @(statusFilter == "Approved" ? "active" : "")"
                    @onclick='() => SetStatus("Approved")'>
                Approved
            </button>

            <button class="btn btn-outline-danger @(statusFilter == "Rejected" ? "active" : "")"
                    @onclick='() => SetStatus("Rejected")'>
                Rejected
            </button>
        </div>

        <span class="ms-auto text-muted small">
            Showing <b>@filtered.Count</b> requests
        </span>
    </div>
</div>

<!-- TABLE -->
<div class="card shadow-sm border-0">
    <div class="table-responsive" style="max-height:520px; overflow-y:auto;">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light position-sticky top-0">
                <tr>
                    <th>User</th>
                    <th>Requested</th>
                    <th>Status</th>
                    <th>Processed</th>
                    <th>Admin Remarks</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>

            <tbody>
                @if (!filtered.Any())
                {
                    <tr>
                        <td colspan="6" class="text-center text-muted py-5">
                            🎉 No requests found
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var r in filtered)
                    {
                        <tr class="@(r.Status == "Pending" ? "table-warning" : "")">

                            <td>
                                <div class="fw-semibold">@r.UserEmail</div>
                                <div class="text-muted small">@r.GoogleId</div>
                            </td>

                            <td>@r.RequestTime.ToString("dd MMM yyyy HH:mm")</td>

                            <td>
                                <span class="badge @GetStatusBadge(r.Status)">
                                    @r.Status
                                </span>
                            </td>

                            <td>
                                @(r.ProcessedTime?.ToString("dd MMM yyyy HH:mm") ?? "-")
                            </td>

                            <td style="max-width:220px;">
                                <textarea class="form-control form-control-sm"
                                          rows="2"
                                          placeholder="Admin remarks"
                                          @bind="r.Remarks"></textarea>
                            </td>

                            <!-- 🔥 ALL ACTIONS ALWAYS AVAILABLE -->
                            <td class="text-end">

                                @if (r.Status != "Approved")
                                {
                                    <button class="btn btn-success btn-sm me-1"
                                            @onclick='() => Approve(r)'>
                                        ✅ Approve
                                    </button>
                                }

                                @if (r.Status != "Rejected")
                                {
                                    <button class="btn btn-danger btn-sm me-1"
                                            @onclick='() => Reject(r)'>
                                        ❌ Reject
                                    </button>
                                }

                                @if (r.Status != "Pending")
                                {
                                    <button class="btn btn-outline-primary btn-sm"
                                            @onclick='() => Revert(r)'>
                                        🔄 Revert
                                    </button>
                                }

                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@code {

    private List<AccountDeletionRequest> all = new();
    private List<AccountDeletionRequest> filtered = new();

    private string statusFilter = "Pending";

    private string _searchText = "";
    private string searchText
    {
        get => _searchText;
        set
        {
            _searchText = value;
            ApplyFilter();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        all = (await Api.GetAllAsync())?.ToList() ?? new();
        ApplyFilter();
    }

    private void ApplyFilter()
    {
        filtered = all
            .Where(x =>
                (statusFilter == "All" || x.Status == statusFilter) &&
                (string.IsNullOrWhiteSpace(searchText)
                 || (x.UserEmail?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false)
                 || (x.GoogleId?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false)))
            .OrderByDescending(x => x.RequestTime)
            .ToList();
    }

    private void SetStatus(string status)
    {
        statusFilter = status;
        ApplyFilter();
    }

    private async Task Approve(AccountDeletionRequest r)
    {
        await Api.UpdateStatusAsync(r.Id, "Approved", r.Remarks);
        await Load();
    }

    private async Task Reject(AccountDeletionRequest r)
    {
        if (string.IsNullOrWhiteSpace(r.Remarks))
            r.Remarks = "Rejected by admin";

        await Api.UpdateStatusAsync(r.Id, "Rejected", r.Remarks);
        await Load();
    }

    private async Task Revert(AccountDeletionRequest r)
    {
        r.Remarks = "Reverted to pending by admin";
        await Api.UpdateStatusAsync(r.Id, "Pending", r.Remarks);
        await Load();
    }

    private string GetStatusBadge(string status) => status switch
    {
        "Pending" => "bg-warning",
        "Approved" => "bg-success",
        "Rejected" => "bg-danger",
        _ => "bg-secondary"
    };
}
