@page "/admin/gifts"
@using SharedLib.DTO
@using SharedLib.Models
@using WASM.api
@inject IGiftApi GiftApi
@inject NavigationManager Nav

<h3 class="mb-3">🎁 Gift Manager</h3>

<input class="form-control mb-3"
       placeholder="Search by provider or prize pool..."
       @bind="searchText"
       @bind:event="oninput" />

<div class="card shadow-sm border-0">
    <div class="card-header bg-white fw-semibold py-3 border-bottom">
        Gift List
    </div>

    <div class="table-responsive" style="max-height: 480px; overflow-y: auto;">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light position-sticky top-0 shadow-sm">
                <tr>
                    <th @onclick="() => SortBy(nameof(GiftMaster.Provider))">Provider</th>
                    <th>Image</th>
                    <th>Prize Pool</th>
                    <th>Winners</th>
                    <th>Coins</th>
                    <th>Slots</th>
                     <th>From</th>
                    <th>To</th>
                    <th>Ends</th>
                    <th>Active</th>
                    <th>Winner Lock</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>

            <tbody>
                @if (!filteredGifts.Any())
                {
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            🚫 No gifts found
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var gift in filteredGifts)
                    {
                        <tr>
                            <td><span class="badge bg-primary">@gift.Provider</span></td>

                            <td>
                                @if (!string.IsNullOrWhiteSpace(gift.Image))
                                {
                                    <img src="@gift.Image"
                                         style="width:70px;height:70px;border-radius:6px;object-fit:cover;" />
                                }
                            </td>

                            <td>@gift.PrizePoolText</td>
                            <td>@gift.WinnerText</td>

                            <td>
                                <span class="badge bg-success">@gift.CoinsRequired</span>
                            </td>

                            <td>
                                <span class="badge bg-info">
                                    @gift.RemainingSlots / @gift.TotalSlots
                                </span>
                            </td>
                            <td>
                                @gift.FromDate.ToString("dd MMM yyyy")
                            </td>

                            <td>
                                @gift.ToDate.ToString("dd MMM yyyy")
                            </td>
                            <td>
                                <span class="badge @GetEndsBadge(gift.ToDate)">
                                    @GetEndsText(gift.ToDate)
                                </span>
                            </td>

                            <td>
                                <span class="badge @(gift.IsActive ? "bg-success" : "bg-secondary")">
                                    @(gift.IsActive ? "Active" : "Inactive")
                                </span>
                            </td>
                            <td>
                                <span class="badge @(gift.IsActive ? "bg-success" : "bg-secondary")">
                                    @(gift.WinnersLocked ? "Locked" : "Not Locked")
                                </span>
                            </td>

                            <td class="text-end">
                                <button class="btn btn-outline-info btn-sm me-1"
                                        @onclick="() => ViewParticipants(gift.Id)">
                                    👥 Joined
                                </button>

                                @if (!gift.WinnersLocked)
                                {
                                    <button class="btn btn-outline-success btn-sm me-1"
                                            disabled="@isLocking"
                                            @onclick="() => LockWinners(gift.Id)">
                                        🏆 Lock Winners
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-outline-warning btn-sm me-1"
                                            disabled="@isLocking"
                                            @onclick="() => UnlockWinners(gift.Id)">
                                        🔓 Unlock Winners
                                    </button>
                                }

                                <button class="btn btn-outline-dark btn-sm me-1"
                                        @onclick="() => ViewWinners(gift.Id)">
                                    👁 Winners
                                </button>

                                <button class="btn btn-outline-primary btn-sm me-1"
                                        @onclick="() => EditGift(gift)">
                                    ✏️ Edit
                                </button>

                                <button class="btn btn-outline-danger btn-sm"
                                        @onclick="() => DeleteGift(gift.Id)">
                                    🗑 Delete
                                </button>
                                <button class="btn btn-outline-danger btn-sm"
                                        @onclick="() => PrepareForceDelete(gift.Id)">
                                    🗑 Force Delete
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<div class="card shadow-sm border-0 mt-4">
    <div class="card-header bg-white fw-semibold py-3 border-bottom">
        @(isEditMode ? "✏️ Edit Gift" : "➕ Create Gift")
    </div>

    <div class="card-body">
        <div class="row g-3">

            <div class="col-md-4">
                <label class="form-label">Provider</label>
                <input class="form-control" @bind="giftModel.Provider" @ref="providerInput" />
            </div>

            <div class="col-md-4">
                <label class="form-label">Prize Pool Amount</label>
                <input class="form-control" @bind="giftModel.WinnerPrizeAmount" />
            </div>

            <div class="col-md-4">
                <label class="form-label">Prize Pool Text</label>
                <input class="form-control" @bind="giftModel.PrizePoolText" />
            </div>

            <div class="col-md-4">
                <label class="form-label">Winners Count</label>
                <input class="form-control" @bind="giftModel.WinnerCount" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Winner Text</label>
                <input class="form-control" @bind="giftModel.WinnerText" />
            </div>

            <div class="col-md-4">
                <label class="form-label">Coins Required</label>
                <input type="number" class="form-control" @bind="giftModel.CoinsRequired" />
            </div>

            <div class="col-md-4">
                <label class="form-label">Total Slots</label>
                <input type="number" class="form-control" @bind="giftModel.TotalSlots" />
            </div>

            <div class="col-md-4">
                <label class="form-label">Remaining Slots</label>
                <input type="number" class="form-control" @bind="giftModel.RemainingSlots" />
            </div>

            <div class="col-md-4">
                <label class="form-label">From Date</label>
                <input type="date"
                       class="form-control"
                       @bind-value="giftModel.FromDate"
                       @bind-value:event="onchange" />
            </div>

            <div class="col-md-4">
                <label class="form-label">To Date</label>
                <input type="date"
                       class="form-control"
                       @bind-value="giftModel.ToDate"
                       @bind-value:event="onchange" />
            </div>

            <div class="col-md-4">
                <label class="form-label">Image URL</label>
                <input class="form-control" @bind="giftModel.Image" />
            </div>


            <div class="col-md-4 d-flex align-items-center mt-3">
                <label class="form-label fw-semibold me-3">Valid</label>
                <label class="switch">
                    <input type="checkbox" @bind="giftModel.IsActive">
                    <span class="slider round"></span>
                </label>
            </div>

            <div class="col-md-4 d-flex align-items-center mt-3">
                <label class="form-label fw-semibold me-3">WinnersLocked</label>
                <label class="switch">
                    <input type="checkbox" @bind="giftModel.WinnersLocked">
                    <span class="slider round"></span>
                </label>
            </div>


            <div class="col-12 mt-3">
                @if (!IsDateValid())
                {
                    <div class="text-danger mb-2">
                        ❌ To Date must be same or after From Date
                    </div>
                }

                @if (isEditMode)
                {
                    <button class="btn btn-warning me-2"
                            disabled="@(!IsDateValid())"
                            @onclick="UpdateGift">
                        💾 Update
                    </button>

                    <button class="btn btn-secondary"
                            @onclick="CancelEdit">
                        ❌ Cancel
                    </button>
                }
                else
                {
                    <button class="btn btn-primary"
                            disabled="@(!IsDateValid())"
                            @onclick="CreateGift">
                        ➕ Create Gift
                    </button>
                }
            </div>
        </div>
    </div>
</div>
@if (showWinnersModal)
{
    <div class="modal fade show d-block" style="background:rgba(0,0,0,.5)">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">🏆 Winners (Gift ID: @selectedGiftId)</h5>
                    <button class="btn-close" @onclick="CloseWinners"></button>
                </div>

                <div class="modal-body">
                    @if (!winners.Any())
                    {
                        <div class="text-muted">No winners found</div>
                    }
                    else
                    {
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Won At</th>
                                    <th>NickName</th>
                                    <th>Address</th>
                                    <th>Phone</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var w in winners)
                                {
                                    <tr>
                                        <td>@w.U_Name (@w.UserId)</td>
                                        <td>@w.Email</td>
                                        <td>@w.WonAt.ToLocalTime()</td>
                                        <td>
                                            <button class="btn btn-link p-0"
                                                    @onclick="() => OpenUser(w.UserId)">
                                                @w.UserName (@w.UserId)
                                            </button>
                                        </td>
                                        <td>@w.U_Address</td>
                                        <td>@w.U_Phone</td>

                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseWinners">Close</button>
                </div>
            </div>
        </div>
    </div>
}
@if (showForceDeleteModal)
{
    <div class="modal fade show d-block" style="background:rgba(0,0,0,.6); z-index:2000;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">⚠️ Force Delete Confirmation</h5>
                    <button class="btn-close btn-close-white" @onclick="CancelForceDelete"></button>
                </div>
                <div class="modal-body p-4 text-center">
                    <div class="mb-3">
                        <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                    </div>
                    <p class="fs-5 fw-bold">Are you absolutely sure?</p>
                    <p class="text-muted">
                        Force deleting Gift ID <strong>@giftIdToForceDelete</strong> will permanently remove all participants and winners. This action cannot be undone.
                    </p>
                </div>
                <div class="modal-footer bg-light border-0">
                    <button class="btn btn-secondary px-4" @onclick="CancelForceDelete">No, Keep it</button>
                    <button class="btn btn-danger px-4" @onclick="ConfirmForceDelete">Yes, Force Delete</button>
                </div>
            </div>
        </div>
    </div>
}
@code {
    private bool isLocking = false;

    private int selectedGiftId;
    private List<GiftWinnerDto> winners = new();
    private bool showWinnersModal = false;
    private List<GiftMaster> allGifts = new();
    private List<GiftMaster> filteredGifts = new();

    private GiftMaster giftModel = CreateDefaultGift();

    private bool isEditMode = false;
    private string searchText = "";
    private string sortColumn = "";
    private bool sortAscending = true;
    private ElementReference providerInput;
    private bool focusProviderAfterEdit;
    private bool showForceDeleteModal = false;
    private int giftIdToForceDelete;
    protected override async Task OnInitializedAsync()
    {
        await LoadGifts();
    }
    private void CloseWinners()
    {
        showWinnersModal = false;
        winners.Clear();
    }
    private async Task LockWinners(int giftId)
    {
        isLocking = true;

        try
        {
            await GiftApi.LockGiftWinnersAsync(giftId);
            await LoadGifts();
        }
        finally
        {
            isLocking = false;
        }
    }
    private async Task ViewWinners(int giftId)
    {
        selectedGiftId = giftId;
        winners = await GiftApi.GetWinnersWithUserAsync(giftId);
        showWinnersModal = true;
    }

    private static GiftMaster CreateDefaultGift()
    {
        return new GiftMaster
        {
            FromDate = DateTime.UtcNow.Date,
            ToDate = DateTime.UtcNow.Date.AddDays(3),
            IsActive = true
        };
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (focusProviderAfterEdit)
        {
            focusProviderAfterEdit = false;
            await providerInput.FocusAsync();
        }
    }

    private async Task LoadGifts()
    {
        allGifts = (await GiftApi.GetAllAsync())?.ToList() ?? new();
        ApplyFilter();
    }

    private void ApplyFilter()
    {
        filteredGifts = allGifts
            .Where(g =>
                string.IsNullOrWhiteSpace(searchText)
                || g.Provider.Contains(searchText, StringComparison.OrdinalIgnoreCase)
                || g.PrizePoolText.Contains(searchText, StringComparison.OrdinalIgnoreCase))
            .ToList();

        ApplySorting();
    }

    private void SortBy(string column)
    {
        sortAscending = sortColumn == column ? !sortAscending : true;
        sortColumn = column;
        ApplySorting();
    }

    private void ApplySorting()
    {
        if (!string.IsNullOrEmpty(sortColumn))
        {
            filteredGifts = sortAscending
                ? filteredGifts.OrderBy(g => g.GetType().GetProperty(sortColumn)?.GetValue(g)).ToList()
                : filteredGifts.OrderByDescending(g => g.GetType().GetProperty(sortColumn)?.GetValue(g)).ToList();
        }
    }

    private async Task CreateGift()
    {
        await GiftApi.CreateAsync(giftModel);
        giftModel = CreateDefaultGift();
        await LoadGifts();
    }

    private void EditGift(GiftMaster gift)
    {
        giftModel = new GiftMaster
        {
            Id = gift.Id,
            Provider = gift.Provider,
            PrizePoolText = gift.PrizePoolText,
            WinnerText = gift.WinnerText,
            CoinsRequired = gift.CoinsRequired,
            TotalSlots = gift.TotalSlots,
            RemainingSlots = gift.RemainingSlots,
            Image = gift.Image,
            FromDate = gift.FromDate.Date,
            ToDate = gift.ToDate.Date,
            IsActive = gift.IsActive,
            WinnerCount = gift.WinnerCount,
            WinnerPrizeAmount = gift.WinnerPrizeAmount,
            WinnersLocked = gift.WinnersLocked
        };

        isEditMode = true;
        focusProviderAfterEdit = true;
    }

    private async Task UpdateGift()
    {
        await GiftApi.UpdateAsync(giftModel.Id, giftModel);
        isEditMode = false;
        giftModel = CreateDefaultGift();
        await LoadGifts();
    }

    private void CancelEdit()
    {
        isEditMode = false;
        giftModel = CreateDefaultGift();
    }

    private async Task DeleteGift(int id)
    {
        await GiftApi.DeleteAsync(id);
        await LoadGifts();
    }
    private async Task ForceDeleteGift(int id)
    {
        await GiftApi.ForceDeleteAsync(id);
        await LoadGifts();
    }

    private bool IsDateValid()
    {
        return giftModel.ToDate.Date >= giftModel.FromDate.Date;
    }

    private string GetEndsText(DateTime toDate)
    {
        var days = (toDate.Date - DateTime.UtcNow.Date).Days;

        if (days < 0) return "Ended";
        if (days == 0) return "Ends today";
        if (days == 1) return "Ends in 1 day";
        return $"Ends in {days} days";
    }

    private string GetEndsBadge(DateTime toDate)
    {
        var days = (toDate.Date - DateTime.UtcNow.Date).Days;

        if (days < 0) return "bg-danger";
        if (days == 0) return "bg-warning";
        return "bg-info";
    }
    private void ViewParticipants(int giftId)
    {
        Nav.NavigateTo($"/admin/gifts/{giftId}/participants");
    }
    private void OpenUser(string userId)
    {
        Nav.NavigateTo($"/admin/users?selectedUserId={userId}");
    }
    private void PrepareForceDelete(int id)
    {
        giftIdToForceDelete = id;
        showForceDeleteModal = true;
    }

    private void CancelForceDelete()
    {
        showForceDeleteModal = false;
    }

    private async Task ConfirmForceDelete()
    {
        showForceDeleteModal = false; // Close modal immediately
        await GiftApi.ForceDeleteAsync(giftIdToForceDelete);
        await LoadGifts();
    }
    private async Task UnlockWinners(int giftId)
    {
        isLocking = true;

        try
        {
            await GiftApi.UnlockGiftWinnersAsync(giftId);
            await LoadGifts(); // refresh list
        }
        finally
        {
            isLocking = false;
        }
    }
}

<style>
    .modern-input {
        border-radius: 8px;
        padding: 10px;
        border: 1px solid #ced4da;
        transition: 0.25s;
    }

        .modern-input:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.15rem rgba(13,110,253,0.25);
        }

    .modern-btn {
        border-radius: 8px;
        transition: .2s;
    }

        .modern-btn:hover {
            transform: scale(1.08);
        }

    .table-row-modern:hover {
        background-color: #eef3ff !important;
        transition: .2s;
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 24px;
    }

        .switch input {
            display: none;
        }

    .slider {
        position: absolute;
        cursor: pointer;
        background-color: #ccc;
        border-radius: 34px;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        transition: .4s;
    }

        .slider:before {
            content: "";
            position: absolute;
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

    input:checked + .slider {
        background-color: #0d6efd;
    }

        input:checked + .slider:before {
            transform: translateX(24px);
        }
</style>