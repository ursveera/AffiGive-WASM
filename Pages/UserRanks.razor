@page "/admin/ranks"
@using SharedLib.DTO
@using WASM.api
@inject IUserApi UserApi
@inject NavigationManager Nav


<h3 class="mb-3">🏆 User Rankings (Admin)</h3>

<div class="card mb-3 p-3">
    <div class="row g-2 align-items-end">
        <div class="col-md-3">
            <label class="form-label">Year</label>
            <input type="number"
                   class="form-control"
                   @bind="selectedYear"
                   @bind:event="onchange"
                   @bind:after="LoadBySelectedMonth" />
        </div>

        <div class="col-md-3">
            <label class="form-label">Month</label>
            <select class="form-select"
                    @bind="selectedMonth"
                    @bind:event="onchange"
                    @bind:after="LoadBySelectedMonth">
                @for (int m = 1; m <= 12; m++)
                {
                    <option value="@m">@MonthNames[m - 1]</option>
                }
            </select>
        </div>

        <div class="col-md-6 text-end">
            <button class="btn btn-primary me-2"
                    @onclick="LoadCurrentMonth">
                🔄 Load Current Month
            </button>

            @if (!isLocked)
            {
                <button class="btn btn-danger"
                        @onclick="LockWinners">
                    🔒 Lock Winners
                </button>
                if(unlocked)
                {
                    <button class="btn btn-warning"
                            @onclick="UnlockGiftNow">
                        🔓 Unlock Gift Now
                    </button>
                }
            }
            else
            {
                <button class="btn btn-warning"
                        @onclick="UnlockWinners">
                    🔓 Unlock Winners
                </button>
            }
        </div>
    </div>

    <small class="text-muted d-block mt-2">
        @statusText
    </small>
</div>

@if (ranks == null)
{
    <p class="text-muted">Loading...</p>
}
else if (!ranks.Any())
{
    <div class="alert alert-warning">No data available.</div>
}
else
{
    <div class="card shadow-sm border-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Rank</th>
                        <th>User</th>
                        <th>Email</th>
                        <th>Coins</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var r in ranks)
                    {
                        <tr>
                            <td class="fw-bold">
                                @if (r.RankPosition == 1)
                                {
                                    <span>🥇</span>
                                }
                                else if (r.RankPosition == 2)
                                {
                                    <span>🥈</span>
                                }
                                else if (r.RankPosition == 3)
                                {
                                    <span>🥉</span>
                                }
                                else
                                {
                                    <span>#@r.RankPosition</span>
                                }
                            </td>

                            <td>
                                <div class="d-flex align-items-center">
                                    @if (!string.IsNullOrWhiteSpace(r.ProfileImage))
                                    {
                                        <img src="@r.ProfileImage"
                                             class="rounded-circle me-2"
                                             style="width:40px;height:40px"
                                             />
                                    }
                                    <strong>@r.Name</strong>
                                </div>
                            </td>

                            <td>@r.Email</td>

                            <td>
                                <span class="badge bg-success fs-6">
                                    @r.TotalCoins
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@code {

    // -------------------------
    // DATA
    // -------------------------

    private List<UserRankDto>? ranks;

    private int selectedYear = DateTime.Now.Year;
    private bool unlocked = false;
    private int selectedMonth = DateTime.Now.Month;

    private bool isLocked;
    private string statusText = "";

    // Month names (Razor-safe)
    private static readonly string[] MonthNames =
        System.Globalization.CultureInfo
            .CurrentCulture
            .DateTimeFormat
            .MonthNames;

    // -------------------------
    // LIFECYCLE
    // -------------------------

    protected override async Task OnInitializedAsync()
    {
        await LoadBySelectedMonth();
    }

    // -------------------------
    // CORE LOGIC
    // -------------------------

    private async Task LoadBySelectedMonth()
    {
        // var now = DateTime.Now;

        // bool isCurrentMonth =
        //     selectedYear == now.Year &&
        //     selectedMonth == now.Month;

        // if (isCurrentMonth)
        // {
        //     // Live leaderboard
        //     ranks = await UserApi.GetTopUserRanksAsync();
        //     isLocked = false;
        //     statusText = "Live leaderboard (refresh-based, not real-time)";
        // }
        // else
        // {
        //     // Locked winners
        //     ranks = await UserApi.GetMonthlyWinnersArrayAsync(selectedYear, selectedMonth);
        //     isLocked = true;
        //     statusText = $"🔒 Winners locked for {MonthNames[selectedMonth - 1]} {selectedYear}";
        // }
        isLocked = await UserApi.IsMonthLockedAsync(selectedYear, selectedMonth);

        if (isLocked)
        {
            ranks = await UserApi.GetMonthlyWinnersArrayAsync(selectedYear, selectedMonth);
            statusText = $"🔒 Winners locked for {MonthNames[selectedMonth - 1]} {selectedYear}";
        }
        else
        {
            ranks = await UserApi.GetTopUserRanksAsync();
            statusText = "Live leaderboard (not locked)";
        }
    }
    private async Task UnlockWinners()
    {
        if (!await ConfirmAsync())
            return;

        if(await UserApi.UnlockMonthlyWinnersAsync(selectedYear, selectedMonth))
        {
            unlocked = true;
        }
        await LoadBySelectedMonth();
    }

    private async Task LoadCurrentMonth()
    {
        selectedYear = DateTime.Now.Year;
        selectedMonth = DateTime.Now.Month;
        await LoadBySelectedMonth();
    }

    private async Task LockWinners()
    {
        if (!await ConfirmAsync())
            return;

        await UserApi.LockMonthlyWinnersAsync(selectedYear, selectedMonth, 10);

        ranks = await UserApi.GetMonthlyWinnersArrayAsync(selectedYear, selectedMonth);
        isLocked = true;
        statusText = $"🔒 Winners locked for {MonthNames[selectedMonth - 1]} {selectedYear}";
    }

    private async Task<bool> ConfirmAsync()
    {
        // Replace with modal if needed
        return await Task.FromResult(true);
    }
    private void UnlockGiftNow()
    {
        Nav.NavigateTo($"/admin/gifts");
    }
}
